<Project TreatAsLocalProperty="IsCrossTargetingProject;EditorConfigDir">
  <PropertyGroup>
    <IsCrossTargetingProject Condition="$(TargetFrameworks) != ''">true</IsCrossTargetingProject>
  </PropertyGroup>
  <Target
    Name="UpdateEditorConfig"
    BeforeTargets="DispatchToInnerBuilds;BeforeBuild"
    Condition=" '$(IsCrossTargetingProject)' == '$(IsCrossTargetingBuild)' "
  >
    <PropertyGroup>
      <EditorConfigDir>$(SolutionDir)</EditorConfigDir>
      <EditorConfigDir
        Condition=" ('$(EditorConfigDir)' == '' or '$(EditorConfigDir)' == '*Undefined*') and '$(MSBuildProjectDirectory)' != ''"
        >$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), Directory.Packages.props))</EditorConfigDir
      >
      <EditorConfigDir
        Condition=" ('$(EditorConfigDir)' == '' or '$(EditorConfigDir)' == '*Undefined*') and '$(ProjectDir)' != '' "
        >$([MSBuild]::GetDirectoryNameOfFileAbove($(ProjectDir), Directory.Packages.props))</EditorConfigDir
      >
    </PropertyGroup>
    <PropertyGroup>
      <EditorConfigSource>$(MSBuildThisFileDirectory)..\configurations\editorconfig.txt</EditorConfigSource>
      <EditorConfigDest>$([MSBuild]::NormalizePath('$(EditorConfigDir)', '.editorconfig'))</EditorConfigDest>
      <CopyCommand Condition="'$(OS)' == 'Windows_NT'"
        >pwsh -NoProfile -NonInteractive -Command "Copy-Item -Path '$(EditorConfigSource)' -Destination '$(EditorConfigDest)' -Force -ErrorAction SilentlyContinue"</CopyCommand
      >
      <CopyCommand Condition="'$(OS)' != 'Windows_NT'"
        >bash -c "cp -f '$(EditorConfigSource)' '$(EditorConfigDest)' 2&gt;/dev/null || true"</CopyCommand
      >
    </PropertyGroup>
    <Exec Command="$(CopyCommand)" ContinueOnError="true" IgnoreExitCode="true" />
  </Target>
</Project>
